# システム音声入力機能の実装

## 概要
リアルタイム翻訳アプリに、マイク入力に加えてシステム音声（他のアプリケーションやブラウザタブの音声）を入力ソースとして使用できる機能を追加しました。

## 実装した機能

### 1. 音声入力モード選択
- **マイクロフォン**: 従来のマイク入力
- **システム音声**: 他のアプリ/ブラウザタブの音声入力

### 2. システム音声取得機能
- `getDisplayMedia` APIを使用してシステム音声を取得
- 音声トラックのみを抽出し、ビデオトラックは自動停止してリソース節約
- 画面共有が終了された際の自動クリーンアップ

### 3. エラーハンドリング
- ブラウザサポートチェック
- 音声トラック存在確認
- 権限拒否時の適切なメッセージ表示
- システム音声トラックの状態監視

### 4. UI改善
- 音声入力モード選択のラジオボタン
- システム音声接続状態の表示
- 使用方法のヒント表示
- 音声認識中の入力ソース表示

## 使用方法

### システム音声の設定
1. 音声入力モードで「システム音声（他のアプリ/ブラウザタブ）」を選択
2. 画面共有ダイアログが表示される
3. 音声付きのアプリケーションまたはブラウザタブを選択
4. 「音声を共有」にチェックが入っていることを確認して共有開始

### 対応アプリケーション例
- YouTube、Netflix などの動画サイト
- Zoom、Teams などの会議アプリ
- Spotify などの音楽アプリ
- その他音声出力があるアプリケーション

### システム音声での翻訳開始
1. システム音声が接続されていることを確認
2. OpenAI APIキーを入力
3. 「翻訳開始」ボタンをクリック
4. 選択したアプリの音声がリアルタイムで翻訳される

## 技術詳細

### ファイル変更
- `src/App.tsx`: UI追加、システム音声管理機能
- `src/services/VoiceRecognitionService.ts`: カスタムストリーム処理強化
- `src/services/RealTimeTranslatorService.ts`: システム音声設定対応

### 主要な実装
1. **システム音声取得**
   ```typescript
   const stream = await navigator.mediaDevices.getDisplayMedia({ 
     audio: { ... }, 
     video: { ... } 
   });
   ```

2. **音声トラック抽出**
   ```typescript
   const audioTracks = stream.getAudioTracks();
   const audioStream = new MediaStream(audioTracks);
   ```

3. **VoiceRecognitionServiceとの統合**
   ```typescript
   customStream: audioInputMode === 'system' ? systemAudioStream : undefined
   ```

### セキュリティ考慮事項
- `getDisplayMedia`は HTTPS 環境でのみ動作
- ユーザーの明示的な許可が必要
- 画面共有の停止と連動した自動クリーンアップ

## 制限事項
- Chrome、Edge、Firefox の最新版でサポート
- HTTPS環境が必要
- 一部のDRM保護されたコンテンツは音声取得不可
- システム音声とマイク音声の同時使用は不可

## トラブルシューティング

### よくある問題
1. **「音声が含まれていません」エラー**
   - 音声付きのタブ/アプリを選択
   - 「音声を共有」がチェックされているか確認

2. **ブラウザサポートエラー**
   - 最新のブラウザを使用
   - HTTPS環境で実行

3. **権限拒否エラー**
   - 画面共有を許可
   - ブラウザの設定で画面共有を有効化
